import { TransactionTracer } from '@evm-transaction-trace/tracer'
import { type Address, erc20Abi, type PublicClient } from 'viem'
import { getUnlimitedBalanceAndApprovalStateOverrides } from '../../tracer/src/token-slot-override'
import { hyperBrickFactoryAbi } from './abi/HyperBrickFactory.abi'
import { HyperBrickPairABI } from './abi/HyperBrickPair.abi'
import { LBRouterAbi } from './abi/LBRouterabi'
import { OBExecutorAbi } from './abi/obExecutorAbi'
import { RouterAbi } from './abi/routerabi'
import { getPublicClient } from './client'
import { ETHERSCAN_API_KEY, RPC_URL } from './config'
import { ERC20A, EXECUTOR, LBRouter, ROUTER } from './constants'

const client = getPublicClient(RPC_URL) as PublicClient
export const TOKEN = '0x9FDBdA0A5e284c32744D2f17Ee5c74B284993463'
const SENDER: Address = '0xc91E7af2E874A2e04183908AdD8b5c3bDb515CFC'

const tracer = new TransactionTracer(client, {
  cachePath: `./tx-cache-dir`,
  cacheOptions: {
    etherscanApiKey: ETHERSCAN_API_KEY,
    byAddress: {
      [ROUTER]: RouterAbi,
      [LBRouter]: LBRouterAbi,
      [EXECUTOR]: OBExecutorAbi,
      [ERC20A]: erc20Abi,
    },
    extraAbis: [
      RouterAbi,
      erc20Abi,
      OBExecutorAbi,
      LBRouterAbi,
      HyperBrickPairABI,
      hyperBrickFactoryAbi,
    ],
  },
})

await tracer.init()

const trace = await tracer.traceCall({
  account: SENDER,
  blockTag: 'latest',
  to: ROUTER,
  data: '0xd46cadbc0000000000000000000000009fdbda0a5e284c32744d2f17ee5c74b28499346300000000000000000000000000000000000000000000000000000002540be400000000000000000000000000555555555555555555555555555555555555555500000000000000000000000000000000000000000000221373d05966d80000000000000000000000000000000000000000000000000022135d7b58f345826fe7000000000000000000000000c91e7af2e874a2e04183908add8b5c3bdb515cfc000000000000000000000000000000000000000000000000000000000000012000000000000000000000000007b93b6766a40df8c96440dc55708ca99722987200000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000276555555555555555555555555555555555555555500000000000000000000000000000000000000000000000000221373d05966d800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000019FDBdA0A5e284c32744D2f17Ee5c74B2849934630462e8013A36B04bcC1D5E2E303981eF643D2668E00b43e70007B93B6766A40Df8C96440DC55708ca99722987225ed0143779F5E56720FbD7F99a18ca4B625838bEC934C0007B93B6766A40Df8C96440DC55708ca9972298724859010D6ECB912b6ee160e95Bc198b618Acc1bCb925250007B93B6766A40Df8C96440DC55708ca997229872ffff01467364bd2a633208b4534f5b7eC11d24604546e40107B93B6766A40Df8C96440DC55708ca99722987201fD739d4e423301CE9385c1fb8850539D657C296D051523015Cbe810071DE393de35e574Fb2830E16dA794bab0007B93B6766A40Df8C96440DC55708ca9972298720f8401f37BEFa5De220E52fb06b02087f5Ba650377d0ad0007B93B6766A40Df8C96440DC55708ca997229872d4ea01be352daF66af94ccF2012a154a67DAEF95FAcB910007B93B6766A40Df8C96440DC55708ca99722987276411d88B214eC94276B825E641820D5C97a9042F9Dd600107B93B6766A40Df8C96440DC55708ca9972298725555555555555555555555555555555555555555ffff264044e34336e41B9653931C4E0717587837993cA2555555555555555555555555555555555555555507B93B6766A40Df8C96440DC55708ca997229872000000000000000000000000000000000000000000000000000000000000000100000000000000000000',
  tracer: 'callTracer',
  chain: client.chain,
  tracerConfig: { withLog: true },
  stateOverride: getUnlimitedBalanceAndApprovalStateOverrides(
    SENDER,
    TOKEN,
    ROUTER,
  ),
})

console.log(trace)
