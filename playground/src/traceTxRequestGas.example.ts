import {
  getUnlimitedBalanceAndApprovalStateOverrides,
  LogVerbosity,
  TransactionTracer,
} from '@evm-tt/tracer'
import { erc20Abi, type PublicClient } from 'viem'
import { CFG } from '../abis/CFG'
import { FiatTokenProxyAbi } from '../abis/FiatTokenProxy'
import { FiatTokenProxy2 } from '../abis/FiatTokenProxyV2'
import { Permit2 } from '../abis/Permit2'
import { PoolManager } from '../abis/PoolManager'
import { UniSwapPool } from '../abis/UniswapPool'
import { UniversalRouter } from '../abis/UniversalRouter'
import { getPublicClient } from './client'

const SENDER = '0xda8A8833E938192781AdE161d4b46c4973A40402'
const TO = '0x66a9893cC07D91D95644AEDD05D03f95e1dBA8Af'
const TOKEN = '0xdAC17F958D2ee523a2206206994597C13D831ec7'

const client = getPublicClient('https://ethereum-mainnet.gateway.tatum.io') as PublicClient

const tracer = new TransactionTracer(client, {
  cachePath: `./tx-cache-dir`,
  cacheOptions: {
    // provinding etherscan api key, lets the package query all the contract names and methods

    // etherscanApiKey: ETHERSCAN_API_KEY,

    // if no api key is provided, manualy abi config is neeeded to resolve contract abi info
    byAddress: {
      ['0xcccccccccc33d538dbc2ee4feab0a7a1ff4e8a94']: {
        name: 'CFG',
        abi: erc20Abi,
      },
      ['0xdac17f958d2ee523a2206206994597c13d831ec7']: {
        name: 'USDT',
        abi: erc20Abi,
      },
      ['0x000000000022d473030f116ddee9f6b43ac78ba3']: {
        name: 'Permit2',
        abi: Permit2,
      },
      ['0x3416cf6c708da44db2624d63ea0aaef7113527c6']: {
        name: 'UniswapV3Pool',
        abi: UniSwapPool,
      },
      ['0x66a9893cc07d91d95644aedd05d03f95e1dba8af']: {
        name: 'UniversalRouter',
        abi: UniversalRouter,
      },
      ['0x000000000004444c5dc75cb358380d2e3de08a90']: {
        name: 'PoolManager',
        abi: PoolManager,
      },
      ['0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48']: {
        name: 'FiatTokenProxy',
        abi: FiatTokenProxyAbi,
      },
      ['0x43506849d7c04f9138d1a2050bbf3a0c054402dd']: {
        name: 'FiatTokenV2_2',
        abi: FiatTokenProxy2,
      },
    },
    extraAbis: [
      CFG,
      FiatTokenProxyAbi,
      FiatTokenProxy2,
      Permit2,
      PoolManager,
      UniSwapPool,
      UniversalRouter,
      erc20Abi,
    ],
  },
  verbosity: LogVerbosity.Highest,
})

if (import.meta.main) {
  const [error, trace] = await tracer.traceGasCall({
    account: SENDER,
    blockNumber: 23212888n,
    to: TO,
    data: '0x3593564c000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000068ab678a00000000000000000000000000000000000000000000000000000000000000050a00100604000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000002200000000000000000000000000000000000000000000000000000000000000340000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000008800000000000000000000000000000000000000000000000000000000000000160000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000ffffffffffffffffffffffffffffffffffffffff0000000000000000000000000000000000000000000000000000000068d2ed4e000000000000000000000000000000000000000000000000000000000000000200000000000000000000000066a9893cc07d91d95644aedd05d03f95e1dba8af0000000000000000000000000000000000000000000000000000000068ab675600000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000041c34d9b0f6434f4d6ef00b2b3159d2a1f5988a5537312d06e07c163024a74b330263dfa8956cd830eb6697c45085bcc383702b39fbf1a3ea69ddf8830a6470bcc1c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000015af43ac000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002ba0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000064dac17f958d2ee523a2206206994597c13d831ec700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004a00000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000030b070e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000003800000000000000000000000000000000000000000000000000000000000000060000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec78000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002800000000000000000000000000000000000000000000000000000000000000020000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec7000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001f4000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000cccccccccc33d538dbc2ee4feab0a7a1ff4e8a94000000000000000000000000000000000000000000000000000000000000271100000000000000000000000000000000000000000000000000000000000000c8000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000cccccccccc33d538dbc2ee4feab0a7a1ff4e8a94000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000cccccccccc33d538dbc2ee4feab0a7a1ff4e8a94000000000000000000000000000000fee13a103a10d593b9ae06b3e05f2e7e1c00000000000000000000000000000000000000000000000000000000000000190000000000000000000000000000000000000000000000000000000000000060000000000000000000000000cccccccccc33d538dbc2ee4feab0a7a1ff4e8a94000000000000000000000000da8a8833e938192781ade161d4b46c4973a40402000000000000000000000000000000000000000000000031f25585d4ebc644aa0c',
    chain: client.chain,
    kzg: undefined,
    showProgressBar: true,
    streamLogs: true,
    stateOverride: getUnlimitedBalanceAndApprovalStateOverrides(SENDER, TOKEN, TO),
  })

  if (error) {
    console.log(error)
    process.exit(1)
  }
  console.log(trace)
  process.exit(0)
}
